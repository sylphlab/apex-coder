<!-- Version: 1.16 | Last Updated: 2025-07-04 --> <!-- Updated Version -->

# Active Context: Apex Coder

**MAJOR PIVOT:** Switched backend AI library from Google Genkit to **Vercel AI SDK**.

**Current Status:** Foundational structure (Extension, WebView) complete. Basic communication tested. Project structure moved to root. Genkit integration attempt abandoned. Refactoring to Vercel AI SDK complete (code implemented).

**Focus:** Testing the Vercel AI SDK integration within the standard VS Code environment.

**Activation Issue Resolved:** Previous activation failures were identified as specific to the Cursor editor environment. Standard VS Code environment activates the extension correctly. User has pulled the project state corresponding to the completed Vercel AI SDK refactoring.

**Immediate Next Steps:**
1.  **Fix Completed:** Resolved `command not found` error for `apex-coder.setApiKey` and `apex-coder.showPanel`. User confirmed the command is now working.
2.  **Implemented:** Added logic to `apex-coder.setApiKey` command in `extension.ts` to prompt for provider/key and store using Secrets API.
3.  **Implemented:** Updated `apex-coder.showPanel` command in `extension.ts` to load the actual Vue.js frontend from `webview-ui/dist` using `getWebviewContent`, including asset path handling and CSP.
4.  **Refactored:** Modified `extension.ts` to support a Webview-driven setup flow:
    *   Removed automatic model initialization on activation.
    *   `showPanelCommand` now sends initial config status (`configStatus`) to Webview.
    *   Added `saveConfiguration` message handler to receive settings from Webview, save them (settings.json, secrets), and attempt model initialization.
    *   Updated `getConfigStatus` (was `checkStatus`) and `sendMessage` handlers to work with the new dynamic initialization flow.
5.  **Fix:** Resolved `net::ERR_ACCESS_DENIED` by correcting the regex in `getWebviewContent` to properly handle absolute asset paths (`/assets/...`) generated by Vite build. Also confirmed that a full VS Code restart (not just F5/Reload Window) is sometimes necessary for Webview changes to take effect. <!-- Updated Fix -->
6.  **User Feedback:** User requested a more intuitive setup flow instead of manual settings/command usage.
7.  **Implemented (Frontend):** Modified `webview-ui/src/App.vue` to handle Webview-driven setup flow (conditional rendering, setup form, message handling).
    *   Listen for `configStatus` message and conditionally render setup form or chat UI.
    *   Implement setup form for Provider, Model ID, API Key, Base URL.
    *   Send `saveConfiguration` message on form submission.
    *   Handle `configSaved` and `configError` messages.
    *   Connect chat input/output to `sendMessage`, `aiResponseChunk`, `aiResponseComplete` messages.
        *   Connect status button to `getConfigStatus`.
    8.  **Implemented (Frontend):** Changed Provider and Model ID inputs in `App.vue` setup form to dropdown selects with predefined options (including Google Gemini models). Added logic for conditional display of API Key/Base URL fields and handling custom model IDs.
    9.  **Refactored:** Modified `src/extension.ts` to support loading Webview content from Vite dev server (`IS_DEVELOPMENT = true`) for hot-reloading during development.
8.  **Ready for Testing:** Test the complete setup and chat flow. This includes: <!-- Updated Status -->
    *   **Build Vue App:** Run `pnpm --filter webview-ui build` in the project root.
    *   Running the extension (F5), executing `Apex Coder: Show Apex Coder Panel` (should now show the Vue app without access errors).
    *   Verifying the setup screen appears if config is missing.
    *   Completing the setup via the Webview interface.
    *   Verifying the chat interface appears after setup.
    *   Testing sending a message and receiving the streamed response.
    *   Testing sending a message from the Vue app and receiving the streamed response.

**Decisions Made:**
- Project Name: Apex Coder
- Core Tech Stack: VSCode Ext (TS), Vue.js (WebView), **Vercel AI SDK (Integrated)**
- MVP Focus: Chat Agent, Streaming, Tool Calling (Vercel AI SDK equivalent), Flexible Config, Checkpointing (Vercel AI SDK equivalent).
- Integration Approach: Integrate Vercel AI SDK directly into Extension Host (方案 A).

**Open Questions/Risks:**
- Performance of Vercel AI SDK within Extension Host.
- Handling diverse provider configurations dynamically with Vercel AI SDK.
- Secure credential handling with Vercel AI SDK.