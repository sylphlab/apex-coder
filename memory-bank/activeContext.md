<!-- Version: 1.33 | Last Updated: 2025-07-08 --> <!-- Updated Version -->

# Active Context: Apex Coder

**MAJOR PIVOT:** Switched backend AI library from Google Genkit to **Vercel AI SDK**.

**Current Status:** Foundational structure (Extension, WebView) complete. Basic communication tested. Project structure moved to root. Vercel AI SDK integrated. UI styling refactored to use UnoCSS. Auto-panel display implemented. **UnoCSS styles confirmed working in both browser and WebView.**

**Focus:** **Provider-First Architecture** - Redesigned the AI provider system to use a modular, file-based approach for better maintainability.

**Activation Issue Resolved:** Previous activation failures were identified as specific to the Cursor editor environment. Standard VS Code environment activates the extension correctly. User has pulled the project state corresponding to the completed Vercel AI SDK refactoring.

**Immediate Next Steps:**
1.  **Fix Completed:** Resolved `command not found` error for `apex-coder.setApiKey` and `apex-coder.showPanel`. User confirmed the command is now working.
2.  **Implemented:** Added logic to `apex-coder.setApiKey` command in `extension.ts` to prompt for provider/key and store using Secrets API.
3.  **Implemented:** Updated `apex-coder.showPanel` command in `extension.ts` to load the actual Vue.js frontend from `webview-ui/dist` using `getWebviewContent`, including asset path handling and CSP.
4.  **Refactored:** Modified `extension.ts` to support a Webview-driven setup flow:
    *   Removed automatic model initialization on activation.
    *   `showPanelCommand` now sends initial config status (`configStatus`) to Webview.
    *   Added `saveConfiguration` message handler to receive settings from Webview, save them (settings.json, secrets), and attempt model initialization.
    *   Updated `getConfigStatus` (was `checkStatus`) and `sendMessage` handlers to work with the new dynamic initialization flow.
5.  **Fix:** Resolved `net::ERR_ACCESS_DENIED` by correcting the regex in `getWebviewContent` to properly handle absolute asset paths (`/assets/...`) generated by Vite build. Also confirmed that a full VS Code restart (not just F5/Reload Window) is sometimes necessary for Webview changes to take effect. <!-- Updated Fix -->
6.  **User Feedback:** User requested a more intuitive setup flow instead of manual settings/command usage.
7.  **Implemented (Frontend):** Modified `webview-ui/src/App.vue` to handle Webview-driven setup flow (conditional rendering, setup form, message handling).
    *   Listen for `configStatus` message and conditionally render setup form or chat UI.
    *   Implement setup form for Provider, Model ID, API Key, Base URL.
    *   Send `saveConfiguration` message on form submission.
    *   Handle `configSaved` and `configError` messages.
    *   Connect chat input/output to `sendMessage`, `aiResponseChunk`, `aiResponseComplete` messages.
        *   Connect status button to `getConfigStatus`.
    8.  **Implemented (Frontend):** Changed Provider and Model ID inputs in `App.vue` setup form to dropdown selects with predefined options (including Google Gemini models). Added logic for conditional display of API Key/Base URL fields and handling custom model IDs.
    9.  **Refactored:** Modified `src/extension.ts` to support loading Webview content from Vite dev server (`IS_DEVELOPMENT = true`) for hot-reloading during development.
    10. **Configured:** Updated `.vscode/launch.json` with a compound launch configuration ("Extension + Vite Dev") to automatically start both the extension host and the Vite dev server when pressing F5.
    11. **Configured:** Enabled CORS in `webview-ui/vite.config.ts` to allow the Webview (running in development mode) to fetch resources from the Vite dev server.
12. **Fix:** Resolved `CodeExpectedError` by adding `apexCoder.ai.provider`, `modelId`, and `baseUrl` to `contributes.configuration` in `package.json`.
13. **UI Refactor (UnoCSS):**
    *   Installed UnoCSS and presets (`@unocss/preset-uno`, `@unocss/preset-attributify`, `@unocss/preset-icons`, `@unocss/reset`) in `webview-ui`.
    *   Created `webview-ui/uno.config.ts`.
    *   Integrated UnoCSS Vite plugin in `webview-ui/vite.config.ts`.
    *   Imported `virtual:uno.css` and reset in `webview-ui/src/main.ts`.
    *   Removed old CSS files (`app.css`, `style.css`) and import from `App.vue`.
    *   Rewrote `<template>` in `App.vue` using UnoCSS utility classes.
    *   **Troubleshooting:** Styles disappeared in Webview and browser.
14. **Auto-Display Panel:**
    *   Added `onStartupFinished` to `activationEvents` in `package.json`.
    *   Added logic to `activate` in `extension.ts` to execute `apex-coder.showPanel` command on startup.
15. **Fix Attempt (UnoCSS):** Added `'unsafe-inline'` to `style-src` in development CSP within `getWebviewContent` in `extension.ts`.
16. **Fix Attempt (UnoCSS):** Reverted `uno.config.ts` (removed `content` property) and re-added reset import to `main.ts`.
17. **Tested & Confirmed:** UnoCSS styles are restored correctly in the **browser** (`http://localhost:5173`).
18. **Tested & Confirmed:** UnoCSS styles are correctly applied within the **VS Code WebView panel**. The underlying styling issue is resolved.
19. **UI Overhaul Started:** Began UI overhaul for a modern Nordic aesthetic.
    *   Analyzed `webview-ui/src/App.vue` structure.
    *   Applied initial style adjustments (padding, title size) to `App.vue`.
20. **UI Styling Applied:** Applied Nordic-inspired styles to `SetupView.vue` and `ChatView.vue` using UnoCSS.
21. **Fix:** Corrected Vue template syntax errors in `ChatView.vue` caused by incorrectly placed comments during `apply_diff`.
22. **Committed:** Committed UI styling changes and Memory Bank updates (Commit `6707987`).
23. **UI Theme Integration:** Refined theme variable usage in `ChatView.vue` for better consistency (status bar border, user message colors).
24. **Committed:** Committed theme integration refinements and Memory Bank updates (Commit `a343f92`).
25. **Provider-First Architecture Implemented:**
    *   Created base provider interface (`BaseAIProvider`) and implementation classes for each provider.
    *   Implemented provider-specific files for Google AI, OpenAI, Anthropic, Ollama, Mistral, Azure, Cohere, and DeepSeek.
    *   Updated `configLoader.ts` to use the new provider architecture.
    *   Modified `AiConfig` interface to use a credentials object for provider-specific settings.
    *   Updated related files (`extension.ts`, `panelManager.ts`, tests) to work with the new architecture.
26. **Completed:** Provider-first architecture implemented.
27. **Implemented (Frontend):** Migrated WebView UI state management (for configuration) from props/emits to Pinia (`configStore.ts`). Refactored `App.vue`, `SetupView.vue`, and `ChatView.vue` to use the store. This resolves the provider selection issue reported by the user.
28. **Paused Task:** Fixing errors in `minimal-react-app/src/main.jsx` is paused pending the addition of `.roo/system-prompt-code`.
29. **Current Task:** Refine secure API key handling.
    *   **Analysis:** Reviewed `src/extension.ts`. Current logic checks for missing keys on activation but only logs a warning. `setApiKey` command handles setup.
    *   **Plan:** Modify activation logic in `src/extension.ts` to show a `showWarningMessage` with an action button to trigger `COMMAND_SET_API_KEY` if a required key is missing.

**Decisions Made:**
- Project Name: Apex Coder
- Core Tech Stack: VSCode Ext (TS), Vue.js (WebView), **Vercel AI SDK (Integrated)**
- MVP Focus: Chat Agent, Streaming, Tool Calling (Vercel AI SDK equivalent), Flexible Config, Checkpointing (Vercel AI SDK equivalent).
- Integration Approach: Integrate Vercel AI SDK directly into Extension Host (方案 A).
- UI Styling: **UnoCSS** (replacing previous manual CSS).
- Activation: Activate on command and **on startup**, automatically show panel.
- **Provider Architecture:** Provider-first design with separate files for each provider.
- **State Management (WebView):** Using Pinia for managing configuration state (`configStore.ts`).

**Open Questions/Risks:**
- Performance of Vercel AI SDK within Extension Host.
- Handling diverse provider configurations dynamically with Vercel AI SDK.
- Secure credential handling with Vercel AI SDK.
- Fine-tuning UnoCSS styles for better VS Code theme integration (part of UI overhaul).